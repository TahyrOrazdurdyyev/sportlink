# üéâ Push Notifications - –ü–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤—ã!

## ‚úÖ –°—Ç–∞—Ç—É—Å

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ —Ä–∞–±–æ—Ç–µ:

### Backend
- ‚úÖ Firebase Admin SDK —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (`requirements.txt`)
- ‚úÖ Credentials —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω: `config/firebase-adminsdk.json`
- ‚úÖ FCM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ credentials –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—É—Ç—è—Ö
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å (EN, RU, TK)

### Mobile App
- ‚úÖ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
- ‚úÖ FCM —Ç–æ–∫–µ–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –≤—Ö–æ–¥–µ
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ foreground/background —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- ‚úÖ Navigation –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–º–µ–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ

## üöÄ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

```bash
cd mobile
flutter run
```

### 2. –í–æ–π—Ç–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

–ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤—Ö–æ–¥–µ –≤ –∫–æ–Ω—Å–æ–ª–∏ –ø–æ—è–≤–∏—Ç—Å—è:
```
FCM Token: fXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX...
FCM token registered with backend
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Ç–æ–∫–µ–Ω–∞ –≤ backend

```bash
cd backend
python manage.py shell
```

```python
from apps.notifications.models import PushToken

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
tokens = PushToken.objects(is_active=True)
for token in tokens:
    print(f"User: {token.user.nickname}")
    print(f"Platform: {token.platform}")
    print(f"Token: {token.token[:50]}...")
    print("---")
```

### 4. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

```bash
python manage.py shell < test_push_notification.py
```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
‚úÖ Found user: john (+99365532570)
‚úÖ Push token: fXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX...
‚úÖ Platform: android

üì§ Sending test notification...
Firebase initialized with credentials from: /path/to/config/firebase-adminsdk.json
Successfully sent message: projects/sportlink-4532d/messages/0:1234567890
‚úÖ Notification created: abc-123-def
‚úÖ Sent: True

üéâ Push notification sent successfully!
Check your mobile device for the notification.
```

### 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ

–í—ã –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:
- **Title**: "Test Notification" (–∏–ª–∏ –Ω–∞ –≤–∞—à–µ–º —è–∑—ã–∫–µ)
- **Body**: "This is a test push notification from Sportlink!"

### 6. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

#### –¢–µ—Å—Ç 1: –ü–æ–∏—Å–∫ –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A** —Å–æ–∑–¥–∞–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:
   - –í—ã–±–∏—Ä–∞–µ—Ç –∫–æ—Ä—Ç
   - –í—ã–±–∏—Ä–∞–µ—Ç –¥–∞—Ç—É/–≤—Ä–µ–º—è
   - –í–∫–ª—é—á–∞–µ—Ç "Find Opponents"
   - –£–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–ø–æ–Ω–µ–Ω—Ç–æ–≤: 1
   - –°–æ–∑–¥–∞–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

2. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B** —Å–æ–∑–¥–∞–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:
   - –í—ã–±–∏—Ä–∞–µ—Ç **—Ç–æ—Ç –∂–µ –∫–æ—Ä—Ç**
   - –í—ã–±–∏—Ä–∞–µ—Ç **—Ç–æ –∂–µ –≤—Ä–µ–º—è**
   - –í–∫–ª—é—á–∞–µ—Ç "Find Opponents"
   - –°–æ–∑–¥–∞–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

3. **–†–µ–∑—É–ª—å—Ç–∞—Ç**:
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A –≤–∏–¥–∏—Ç –¥–∏–∞–ª–æ–≥: "Opponent Found! @userB"
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A –ø–æ–ª—É—á–∞–µ—Ç push: "Opponent Found! @userB"
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B –ø–æ–ª—É—á–∞–µ—Ç push: "Match Found! @userA on [date] at [time]"

#### –¢–µ—Å—Ç 2: –ü—Ä–æ—Å–º–æ—Ç—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

1. –û—Ç–∫—Ä—ã—Ç—å —ç–∫—Ä–∞–Ω "Notifications"
2. –£–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
3. –ù–∞–∂–∞—Ç—å –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Üí –æ–Ω–æ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
4. –ù–∞–∂–∞—Ç—å "Mark all as read" ‚Üí –≤—Å–µ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ

#### –¢–µ—Å—Ç 3: –ü—Ä–æ—Å–º–æ—Ç—Ä –º–∞—Ç—á–µ–π

1. –û—Ç–∫—Ä—ã—Ç—å —ç–∫—Ä–∞–Ω "My Matches"
2. –£–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –º–∞—Ç—á–µ–π
3. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–∂–¥–æ–º –º–∞—Ç—á–µ:
   - –†–æ–ª—å (You invited / Invited you)
   - –û–ø–ø–æ–Ω–µ–Ω—Ç (–Ω–∏–∫–Ω–µ–π–º, –∏–º—è)
   - –ö–æ—Ä—Ç
   - –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è
   - –°—Ç–∞—Ç—É—Å

## üì± –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

- ‚úÖ **Android** - –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ **iOS** - –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–∞–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ)
- ‚ùå **Web** - FCM –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

## üîî –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ:
1. **opponent_matched** - –ù–∞–π–¥–µ–Ω –æ–ø–ø–æ–Ω–µ–Ω—Ç
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ–±–æ–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
   - –°–æ–¥–µ—Ä–∂–∏—Ç –Ω–∏–∫–Ω–µ–π–º –æ–ø–ø–æ–Ω–µ–Ω—Ç–∞, –¥–∞—Ç—É, –≤—Ä–µ–º—è, –∫–æ—Ä—Ç

2. **booking_confirmed** - –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤–ª–∞–¥–µ–ª—å—Ü—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

3. **booking_cancelled** - –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤–ª–∞–¥–µ–ª—å—Ü—É –∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º

### –ì–æ—Ç–æ–≤—ã–µ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:
4. **match_reminder** - –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –º–∞—Ç—á–µ
   - –ó–∞ 1 —á–∞—Å –¥–æ –Ω–∞—á–∞–ª–∞
   - –ó–∞ 1 –¥–µ–Ω—å –¥–æ –Ω–∞—á–∞–ª–∞

5. **payment_received** - –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞

6. **tournament_update** - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—É—Ä–Ω–∏—Ä–∞

7. **system** - –°–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

## üåç –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å

–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ —è–∑—ã–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```python
title_i18n = {
    'en': 'Match Found!',
    'ru': '–ú–∞—Ç—á –Ω–∞–π–¥–µ–Ω!',
    'tk': 'Du≈üu≈üyk tapyldy!',
}

message_i18n = {
    'en': 'You have a match with @john on Dec 25, 10:00 at Court #1',
    'ru': '–£ –≤–∞—Å –º–∞—Ç—á —Å @john 25 –¥–µ–∫–∞–±—Ä—è, 10:00 –Ω–∞ –ö–æ—Ä—Ç #1',
    'tk': '@john bilen 25-nji dekabr, 10:00 wagtynda Kort #1-da du≈üu≈üygy≈àyz bar',
}
```

## üîß Troubleshooting

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:**
   ```python
   from apps.notifications.models import PushToken
   PushToken.objects(user=your_user, is_active=True)
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Firebase credentials:**
   ```bash
   ls -la config/firebase-adminsdk.json
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ backend:**
   - –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: "Firebase initialized with credentials from: ..."
   - –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: "Successfully sent message: ..."

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ:**
   ```python
   from apps.notifications.models import Notification
   Notification.objects(user=your_user).order_by('-created_at').first()
   ```

### iOS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç

1. Push notifications —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ **—Ä–µ–∞–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ** (–Ω–µ —Å–∏–º—É–ª—è—Ç–æ—Ä)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:
   ```dart
   NotificationSettings settings = await _firebaseMessaging.requestPermission();
   print('Permission: ${settings.authorizationStatus}');
   ```
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å capabilities –≤ Xcode:
   - Push Notifications
   - Background Modes ‚Üí Remote notifications

### Android —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `google-services.json` –≤ `android/app/`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Google Services plugin –ø—Ä–∏–º–µ–Ω–µ–Ω
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: `adb logcat | grep FCM`

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Firebase Console

1. –ü–µ—Ä–µ–π—Ç–∏ –≤ [Firebase Console](https://console.firebase.google.com/)
2. –í—ã–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç "sportlink-4532d"
3. Cloud Messaging ‚Üí Metrics:
   - Sent notifications
   - Delivery rate
   - Open rate

### Backend Metrics

```python
from apps.notifications.models import Notification, PushToken
from datetime import datetime, timedelta

# –ê–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
active_tokens = PushToken.objects(is_active=True).count()
print(f"Active tokens: {active_tokens}")

# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ —Å–µ–≥–æ–¥–Ω—è
today = datetime.utcnow().replace(hour=0, minute=0, second=0)
today_notifications = Notification.objects(
    created_at__gte=today,
    is_sent=True
).count()
print(f"Notifications sent today: {today_notifications}")

# –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ —Ç–∏–ø–∞–º
from collections import Counter
types = [n.type for n in Notification.objects(created_at__gte=today)]
print(f"By type: {Counter(types)}")
```

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Ç–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
3. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –º–∞—Ç—á–∞—Ö (–∑–∞ 1 —á–∞—Å, –∑–∞ 1 –¥–µ–Ω—å)
4. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
5. ‚è≥ –î–æ–±–∞–≤–∏—Ç—å rich notifications (–∫–∞—Ä—Ç–∏–Ω–∫–∏, –¥–µ–π—Å—Ç–≤–∏—è)
6. ‚è≥ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- Firebase credentials —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω: `config/firebase-adminsdk.json`
- Project ID: `sportlink-4532d`
- –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- –ö–æ–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ

## ‚ú® –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

–ü—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –≤–æ–π–¥–∏—Ç–µ - push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞—Ä–∞–±–æ—Ç–∞—é—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! üöÄ

